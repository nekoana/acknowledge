> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [juejin.cn](https://juejin.cn/post/7194380995464790076)

å¼•è¨€
--

å…³äºå†…å­˜æ³„æ¼ï¼Œ**Android** å¼€å‘çš„å°ä¼™ä¼´åº”è¯¥éƒ½å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼Œæ¯”å¦‚æœ€å¸¸è§çš„é™æ€ç±»é—´æ¥æŒæœ‰äº†æŸä¸ª **Activity** å¯¹è±¡ï¼Œåˆæ¯”å¦‚æŸä¸ªç»„ä»¶åº“çš„è®¢é˜…åœ¨é¡µé¢é”€æ¯æ—¶æ²¡æœ‰åŠæ—¶æ¸…ç†ç­‰ç­‰ï¼Œè¿™äº›æƒ…å†µä¸‹å¤šæ•°æ—¶éƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œä»è€Œå¯¹æˆ‘ä»¬ App çš„ `æµç•…åº¦` é€ æˆå½±å“ï¼Œæ›´æœ‰ç”šè€…é€ æˆäº† `OOM` çš„æƒ…å†µã€‚

åœ¨ç°ä»£åŒ–å¼€å‘ä»¥åŠå¤šäººåä½œçš„èƒŒæ™¯ä¸‹ï¼Œå¦‚ä½•èƒ½åšåˆ°å¼€å‘ä¸­å¿«é€Ÿçš„ç›‘æµ‹å†…å­˜æ³„æ¼ï¼Œä»è€Œå°½å¯èƒ½æœç»ä¸Šè¿°é—®é¢˜ï¼Œæ­¤æ—¶å°±æ˜¾å¾—æ›´åŠ å°¤ä¸ºé‡è¦ã€‚

_**LeakCanary**_ å°±æ˜¯ä¸€ä¸ªå¯ä»¥å¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ’æŸ¥ä¸Šè¿°é—®é¢˜çš„å·¥å…·ï¼Œè€Œå‡ ä¹æ‰€æœ‰çš„ Android å¼€å‘è€…éƒ½æ›¾ä½¿ç”¨è¿‡è¿™ä¸ªå·¥å…·ï¼Œå…¶èƒŒåçš„è®¾è®¡ä¹Ÿæ˜¯å„å‚è‡ªç ”ç›¸åº”ç»„ä»¶çš„å€Ÿé‰´æ€æƒ³ã€‚

è€Œç†è§£ _**LeakCanary**_ èƒŒåçš„è®¾è®¡æ€æƒ³ä¸åŸç†ï¼Œä¹Ÿæ›´æ˜¯æ¯ä¸ªåº”ç”¨å±‚å¼€å‘è€…æ‰€å¿…ä¸å¯å°‘çš„æŠ€èƒ½ç‚¹ã€‚

æ•…æ­¤ï¼Œæœ¬ç¯‡å°†ä»¥æœ€æ–°çš„è§†è§’ï¼Œä¸ä½ ä¸€èµ·ç”¨åŠ›ä¸€ç¥ **LeakCanary**ã€‚

_LeakCanary_ ç‰ˆæœ¬ï¼š**2.10**

> æœ¬ç¯‡å®šä½ ä¸­ç­‰ï¼Œå°†ä»èƒŒæ™¯åˆ°ä½¿ç”¨æ–¹å¼ï¼Œå†åˆ°æºç è§£æï¼Œå°½å¯èƒ½å…¨é¢ã€æ˜“æ‡‚ã€‚

åŸºç¡€æ¦‚å¿µ
----

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦è§£é‡Šä¸€äº›å¸¸è§çš„åŸºç¡€é—®é¢˜ï¼Œä»¥ä¾¿æ›´å¥½çš„ç†è§£æœ¬ç¯‡ã€‚ğŸ¤”

### ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ

å½“æˆ‘ä»¬ App æ— æ³•é‡Šæ”¾ä¸éœ€è¦çš„å¯¹è±¡å¼•ç”¨æ—¶ï¼Œå³ä¸ºå†…å­˜æ³„æ¼ã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸º:

> **ç”Ÿå‘½å‘¨æœŸé•¿çš„æŒæœ‰äº†ç”Ÿå‘½å‘¨æœŸçŸ­çš„å¯¹è±¡æ‰€å¯¼è‡´**ã€‚

### å¸¸è§å†…å­˜æ³„æ¼åœºæ™¯ï¼Ÿ

*   éé™æ€å†…éƒ¨ç±»ä¸åŒ¿åå†…éƒ¨ç±» (å¯¼è‡´çš„æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨æ—¶, æ¯”å¦‚ `Act` ä¸­çš„ `éé™æ€Handler` )ï¼›
*   å¼‚æ­¥çº¿ç¨‹æŒæœ‰å¤–éƒ¨ `context`(é AppContext) å¼•ç”¨æ‰€å¯¼è‡´çš„å†…å­˜æ³„æ¼ï¼›
*   `service` å¿˜è®°äº†è§£ç»‘æˆ–è€…å¹¿æ’­æ²¡æœ‰è§£é™¤è®¢é˜…ç­‰ï¼›
*   `stream` æµå¿˜è®°å…³é—­ï¼›
*   â€¦

ä½¿ç”¨æ–¹å¼
----

å…³äº **LeakCanary** çš„ä½¿ç”¨æ–¹å¼ï¼Œæ–°æ‰‹å°ä¼™ä¼´å¯ä»¥ä» [å®˜æ–¹æ–‡æ¡£](https://link.juejin.cn?target=https%3A%2F%2Fsquare.github.io%2Fleakcanary%2F "https://square.github.io/leakcanary/") å¾—åˆ°æ›´å¤šï¼Œè¿™é‡Œä»…ä»…åªæ˜¯ä½œä¸ºä¸€ä¸ªç®€å•æ¦‚è¦ã€‚

```
debugImplementation 'com.squareup.leakcanary:leakcanary-android:2.10'
å¤åˆ¶ä»£ç 
```

**LeakCanary** ä½¿ç”¨å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ `Gradle` ä¸­æ·»åŠ ä¾èµ–å³å¯ï¼Œå°±æ˜¯è¿™ä¹ˆ Easy **:)**

å½“æˆ‘ä»¬é¡¹ç›®ç¼–è¯‘è¿è¡Œåï¼Œæ¡Œé¢ä¼šå®‰è£…ä¸€ä¸ª åä¸º **Leask** çš„è½¯ä»¶ï¼Œicon æ˜¯ä¸€ä¸ªå°é¸Ÿçš„å›¾æ ‡ã€‚

å¦‚æœ **app** åœ¨ä½¿ç”¨ä¸­å‡ºç°å†…å­˜æ³„æ¼å¹¶ä¸”è¾¾åˆ°ä¸€å®šæ•°é‡æ—¶ï¼Œå…¶ä¼šè‡ªåŠ¨å¼¹å‡ºä¸€ä¸ªé€šçŸ¥ï¼Œæç¤ºæˆ‘ä»¬è¿›è¡Œå†…å­˜æ³„æ¼åˆ†æã€‚å½“ç‚¹å‡»é€šçŸ¥åï¼Œ**LeakCanary** ä¼šè¿›è¡Œæ³„æ¼å †æ ˆåˆ†æï¼Œå¹¶å°†å…¶æ˜¾ç¤ºåˆ° `Leask` çš„æ³„æ¼åˆ—è¡¨ä¸­ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡å…·ä½“çš„ item ä»è€Œäº†è§£ç›¸åº”çš„æ³„æ¼ä¿¡æ¯ï¼Œå½“ç„¶ä¹Ÿé€šè¿‡æŸ¥çœ‹ `log` æ—¥å¿—è¿›è¡Œåˆ†æã€‚

**å…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤º (å®˜æ–¹æˆªå›¾)**ï¼š

![](https://square.github.io/leakcanary/images/screenshot-2.0.png)

æºç åˆ†æ
----

è¿™ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬å°†ä» **LeakCanary** çš„æºç å‡ºå‘ï¼Œä»è€Œæ¢ç´¢å…¶èƒŒåçš„è®¾è®¡æ€æƒ³ã€‚

### å¦‚ä½•åˆå§‹åŒ–

é—®èµ·è¿™ä¸ªé—®é¢˜ï¼Œç¨æœ‰ç»éªŒçš„å¼€å‘è€…è‚¯å®šéƒ½ä¼šçŒœåˆ°ï¼Œæ—¢ç„¶ä¸éœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–ï¼Œé‚£è‚¯å®šæ˜¯ **ContentProvider** å•¦ã€‚ğŸ˜‰

**å¦‚ä¸‹æ‰€ç¤ºï¼š**

```
internal class MainProcessAppWatcherInstaller : ContentProvider() {
  override fun onCreate(): Boolean {
    val application = context!!.applicationContext as Application
    AppWatcher.manualInstall(application)
    return true
  }
 }
å¤åˆ¶ä»£ç 
```

å…¶å†…éƒ¨å¢åŠ ä¸€ä¸ª **ContentPrvider** , å¹¶åœ¨ `onCreate()` è¿›è¡Œåˆå§‹åŒ–ã€‚

> ä¸è¿‡ **LeakCanary** ä¹Ÿæä¾›äº† **JetPack-startup** çš„æ–¹å¼, å¦‚ä¸‹æ‰€ç¤ºï¼š
> 
> ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c70419e0d124a15988f1daeebfd485c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

åœ¨ä¸Šé¢æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œä¸Šè¿°çš„åˆå§‹åŒ–æ—¶ä¼šè°ƒç”¨ `AppWatcher.manualInstall(application)` æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬çš„æ’å…¥ç‚¹ä¹Ÿå³ä»è¿™é‡Œå¼€å§‹ ğŸ“Œ

#### manualInstall(application)

é¡¾åæ€ä¹‰ï¼Œç”¨äºè¿›è¡Œåˆå§‹åŒ–ç»„ä»¶çš„å®‰è£…ã€‚

![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.5143t9ythn00.png)

ä¸Šè¿°çš„é€»è¾‘ä¸­ï¼Œä¼šå…ˆé€šè¿‡åå°„å»ç»™ **AppWatcher.objectWatcher** è¿›è¡Œèµ‹å€¼ï¼Œç„¶åå®‰è£…å…·ä½“çš„ç»„ä»¶è§‚å¯Ÿè€…ï¼Œå…·ä½“çš„æºç åˆ†æå¦‚ä¸‹æ‰€ç¤ºã€‚

#### **appDefaultWatchers()**

åˆ›å»ºé»˜è®¤ç»„ä»¶è§‚å¯Ÿè€…åˆ—è¡¨ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f209fa7b9a44632adb71ad2dff80f97~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ç”¨äºåˆå§‹åŒ–æˆ‘ä»¬å…·ä½“çš„è§‚å¯Ÿè€…åˆ—è¡¨ï¼Œç›®å‰æ˜¯æ”¯æŒ `Activity` ã€`Fragment` ã€`View` ã€`Service` ï¼Œå¹¶ä¸”è¿™äº›è§‚å¯Ÿè€…éƒ½ä¼ å…¥äº† ä¸€ä¸ªé™æ€çš„ **ReachabilityWatcher** å¯¹è±¡ `objectWatcher`ã€‚

**ReachabilityWatcher æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿ**

ä¸­æ–‡ç¿»è¯‘è¿‡æ¥æ—¶ **å¯è¾¾æ€§è§‚å¯Ÿè€…** ã€‚

> ç®€å•ç†è§£å°±æ˜¯ ç”¨äºç›‘å¬æˆ‘ä»¬çš„å¯¹è±¡æ˜¯å¦å°†è¦ç«‹åˆ»å˜ä¸ºå¼±å¯è¾¾ï¼Œå…¶æœ¬èº«åªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“å®ç°ç±»ä¸º **ObjectWatcher** ï¼Œä¹Ÿå³æˆ‘ä»¬ä¸Šè¿°åˆå§‹åŒ–æ’ä»¶æ—¶ä¼ é€’çš„å¯¹è±¡ã€‚

è¿™é‡Œå¯èƒ½ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œå…³äºå…·ä½“çš„é€»è¾‘ï¼Œæˆ‘ä»¬ä¸‹é¢è¿˜ä¼šå†è¿›è¡Œè§£é‡Šï¼Œæš‚æ—¶å…ˆæœ‰ä¸ªå°è±¡å³å¯ã€‚ ğŸ˜¶â€ğŸŒ«ï¸

#### **loadLeakCanary(application)**

```
val loadLeakCanary by lazy {
  try {
    val leakCanaryListener = Class.forName("leakcanary.internal.InternalLeakCanary")
    leakCanaryListener.getDeclaredField("INSTANCE")
      .get(null) as (Application) -> Unit
  } catch (ignored: Throwable) {
    NoLeakCanary
  }
}
å¤åˆ¶ä»£ç 
```

è¿™é‡Œæ˜¯ç”¨äºåˆå§‹åŒ– **InternalLeakCanary** ï¼Œä¸è¿‡å› ä¸º **InternalLeakCanary** å±äºä¸Šå±‚æ¨¡å—ï¼Œæ— æ³•ç›´æ¥è°ƒç”¨åˆ°ï¼Œæ‰€ä»¥ä½¿ç”¨äº† `[åå°„]` å»åˆ›å»ºã€‚

> å¯¹äº sdk å¼€å‘è€…è€Œè¨€ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå°æŠ€å·§ï¼Œä½¿ç”¨åå°„çš„æ–¹å¼è¿›è¡Œåˆå§‹åŒ–ï¼Œä»è€Œé¿å…æ¨¡å—é—´çš„è€¦åˆã€‚

**InternalLeakCanary** ç›¸å½“äº LeakCanary çš„å†…éƒ¨å…·ä½“å®ç°ï¼Œå³ä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œè¿›è¡Œå…·ä½“çš„åˆå§‹åŒ–å·¥ä½œã€‚

æˆ‘ä»¬ç›´æ¥å»çœ‹å…¶æºç å³å¯ï¼š

![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.5togpblwoig0.png)

ä¸Šè¿°æºç ä¸»è¦åšäº†ä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼Œå…·ä½“çš„å†…å®¹ï¼Œæˆ‘ä»¬åœ¨æºç ä¸­å¢åŠ äº†æ³¨é‡Šï¼Œå…·ä½“ä¸å¿…è¿‡äºæ·±è¿½ã€‚

ä¸è¿‡å¯¹äº sdk åˆå§‹åŒ–éƒ¨åˆ†ï¼Œè¿˜æ˜¯æœ‰å€¼å¾—æˆ‘ä»¬å­¦ä¹ çš„ä¸€ä¸ªå°åœ°æ–¹ï¼Œè¿™é‡Œå•ç‹¬æå‡ºæ¥ï¼š

> ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/32814ddc06ce4113b1442913a39c8421~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)
> 
> å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™æ˜¯ç”¨äºç›‘å¬ App æ˜¯å¦å¤„äºå‰å°ï¼Œç›¸æ¯”æ™®é€šçš„ä½¿ç”¨ Act å…¨å±€ç›‘å¬ï¼Œè¿™é‡Œè¿˜æ˜¯ç”¨äº†å¹¿æ’­ï¼Œå¹¶ç›‘å¬äº† `ACTION_SCREEN_ON`(å±å¹•å”¤é†’å¹¶æ­£åœ¨äº¤äº’) ä¸ `ACTION_SCREEN_OFF`(å±å¹•å…³é—­) ï¼Œä»è€Œå®ç°äº†æ›´åŠ  **ä¸¥è°¨** çš„åˆ¤æ–­é€»è¾‘ï¼Œå€¼å¾—æˆ‘ä»¬ä¸šåŠ¡ä¸­å‚è€ƒã€‚ğŸ‘

**LeakCanary** åˆå§‹åŒ–éƒ¨åˆ†åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œç›¸å…³çš„ç»†èŠ‚é€»è¾‘åœ¨ä¸Šé¢éƒ½æœ‰æè¿°ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å†åšå™è¿°ã€‚

### å¦‚ä½•æ£€æµ‹å†…å­˜æ³„æ¼

åœ¨æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬å°†èŠèŠ **LeakCanary** æ˜¯å¦‚ä½•åšåˆ°ç›‘å¬ `Act` ã€`Fragment` ç­‰å†…å­˜æ³„æ¼ï¼Œå³å…·ä½“çš„å®ç°é€»è¾‘æ˜¯æ€æ ·çš„ï¼Œä»è€Œç†è§£å…¶è®¾è®¡çš„æ€æƒ³ã€‚

æœ¬å°èŠ‚ä¸ä¼šæ¶‰åŠå…·ä½“çš„å¯¹è±¡æ˜¯å¦æ³„æ¼çš„åˆ¤æ–­ï¼Œæ‰€ä»¥æ›´å¤šçš„æ˜¯æ¡†æ¶çš„å°è£…æ€è€ƒã€‚

åœ¨ä¸Šé¢çš„åˆå§‹åŒ–çš„æºç åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå…¶æœ€ç»ˆä¼šå»è°ƒç”¨ä¸‹è¿°æ–¹æ³•å»æ‰§è¡Œå„ç»„ä»¶çš„ç›‘å¬ï¼š

*   `ActivityWatcher(application, reachabilityWatcher)`;
*   `FragmentAndViewModelWatcher(application, reachabilityWatcher)`;
*   `RootViewWatcher(reachabilityWatcher)`;
*   `ServiceWatcher(reachabilityWatcher)`;

æ‰€ä»¥æˆ‘ä»¬æœ¬èŠ‚çš„æ’å…¥ç‚¹å°±ä»è¿™é‡Œå¼€å§‹ğŸ”ºã€‚

#### ActivityWatcher

ç”¨äºç›‘å¬ Activity çš„è§‚å¯Ÿè€…ï¼Œå…·ä½“å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.2yyg8zh2yq20.png)

å¦‚ä¸Šè¿°é€»è¾‘æ‰€ç¤ºï¼šå†…éƒ¨æ³¨å†Œäº†ä¸€ä¸ª **Activity** çš„å…¨å±€ç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼Œä»è€Œåœ¨ `onDestory()` æ—¶å°† _activity_ çš„å¼•ç”¨äº¤ç»™ **ReachabilityWatcher** å»å¤„ç†åˆ¤æ–­ã€‚

#### FragmentAndViewModelWatcher

ç”¨äºç›‘å¬ **Fragment** å’Œ **ViewModel** çš„è§‚å¯Ÿè€…ï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š

![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.6fafesizcp80.png)

ä¸Šè¿°é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¯¹äº **Fragment** çš„å¯è¾¾æ€§ç›‘å¬æ–¹æ¡ˆï¼Œå…¶å’Œ **Act** ä¸€æ ·ï¼Œå…ˆæ³¨å†Œ _Act-Lifecycle_ ç›‘å¬ï¼Œç„¶ååœ¨ `onCreate()` æ—¶è¿›è¡Œ _Fragment-Lifecycle_ æ³¨å†Œç›‘å¬ï¼Œå†…éƒ¨è°ƒç”¨äº† **FragmentManager** è¿›è¡Œç”Ÿå‘½å‘¨æœŸç›‘å¬æ³¨å†Œã€‚

ğŸ”º ä½†å› ä¸ºæˆ‘ä»¬çš„ **FragmentManager** å®é™…ä¸Šæ˜¯æœ‰ä¸‰ä¸ªç‰ˆæœ¬:

*   `android.app.FragmentManager (Deprecated)`
*   `android.support.v4.app.FragmentManager`
*   `androidx.fragment.app.FragmentManager`

> ä¸Šè¿°ç‰ˆæœ¬ï¼Œç»å†è¿‡çš„å¼€å‘åŒå­¦æƒ³å¿…éƒ½å¾ˆæ¸…æ¥šï¼Œè¿‡å¾€çš„æ•™è®­ï¼Œè¿™é‡Œå°±ä¸å¤šæäº†ğŸ‘¾ã€‚

ç¢äºä¸€äº›å†å²åŸå› ï¼Œæ‰€ä»¥è¦é’ˆå¯¹ä¸‰ä¸ªç‰ˆæœ¬éƒ½åšä¸€äº›åˆ¤æ–­å¤„ç†ã€‚ä¸Šè¿°é€»è¾‘ä¸­ï¼Œå› ä¸º **app.FragmentManager** ç»‘å®šç”Ÿå‘½å‘¨æœŸæ—¶æœ‰é™åˆ¶ï¼Œå¿…é¡» 8.0 ä¹‹åæ‰å¯ä»¥è¿›è¡Œç»‘å®šï¼Œåä¸¤è€…åˆ™æ˜¯åˆ†åˆ«åˆ¤æ–­äº† **AndroidX** ä¸ **Support** ã€‚

æˆ‘ä»¬è¿™é‡Œéšä¾¿æ‹ä¸€ä¸ªå…·ä½“çš„å¤„ç†ä»£ç ï¼Œ `ä»¥ AndroidX ä¸ºä¾‹` ï¼š

![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.2pp1vq7qjig0.png)

å¦‚ä¸Šæ‰€ç¤ºï¼Œåˆ†åˆ«åœ¨ `onFragmentViewDestroyed()` ä¸ `onFragmentDestroyed()` å¯¹ **view å¯¹è±¡** ä¸ **fragment å¯¹è±¡** è¿›è¡Œäº†å¯è¾¾æ€§è¿½è¸ªã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ `invoke()` ä¸ `onFragmentCreated()` æ–¹æ³•ä¸­ï¼Œå†…éƒ¨è¿˜å¯¹ `ViewModel` è¿›è¡Œäº†å¯è¾¾æ€§è¿½è¸ªï¼Œ**è¿™ä¹Ÿæ˜¯æ”¯æŒè¿½è¸ª ViewModel å†…å­˜æ³„æ¼çš„é€»è¾‘æ‰€åœ¨** ã€‚

ç›¸åº”çš„ï¼Œæˆ‘ä»¬åœ¨çœ‹ä¸€çœ¼ ViewModel ä¸­å…·ä½“çš„å®ç°æ€è·¯ã€‚

#### ViewModelClearedWatcher

ç”¨äºç›‘å¬ **ViewModel** æ˜¯å¦æ¸…é™¤çš„è§‚å¯Ÿè€…ï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š

![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.7sfwsw7an6c.png)

åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ `install()` æ’å…¥ä¸€ä¸ª **ViewModel** ï¼Œè¿™ä¸ª ViewModel ç±»ä¼¼ä¸€ä¸ª **[é—´è°]** çš„ä½œç”¨ï¼Œç›®çš„æ˜¯åœ¨ ViewModel **é”€æ¯** æ—¶ï¼Œå³ `onCleard()` æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œé€šè¿‡åå°„æ‹¿åˆ° **ViewModelStore** ä¸­ä¿å­˜çš„ `ViewModelæ•°ç»„` ï¼Œä»è€Œå»å¯¹æ¯ä¸ª ViewModel å¯¹è±¡è¿›è¡Œå¯è¾¾æ€§è¿½è¸ªï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ã€‚

ç»“åˆåœ¨ **Fragment** ä¸­çš„é€»è¾‘ï¼Œæ‰€ä»¥å®Œæ•´çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d87a10a735f40878edd91f129397b7a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

#### RootViewWatcher

ç”¨äºç›‘å¬ **æ ¹è§†å›¾** å¯¹è±¡æ˜¯å¦æ³„æ¼çš„è§‚å¯Ÿè€…ï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š

![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.242w31f8ug80.png)

åˆå§‹åŒ–æ—¶åˆ›å»ºäº†ä¸€ä¸ª **OnRootViewAddedListener** ï¼Œç”¨äºæ‹¦æˆªæ‰€æœ‰æ ¹è§†å›¾çš„åˆ›å»ºï¼Œå…·ä½“ä½¿ç”¨äº† **curtains** åº“å®ç°ã€‚

å½“å‰çª—å£ç±»å‹ æ˜¯ `Dialog` ã€`Tooltip` ã€`Toast` æˆ–è€… `æœªçŸ¥ç±»å‹` æ—¶æ·»åŠ  **View.OnAttachStateChangeListener** ç›‘å¬å™¨ï¼Œå¹¶åˆå§‹åŒ–äº†ä¸€ä¸ª **runable** ç”¨äºæ‰§è¡Œ view å¯¹è±¡å¯è¾¾æ€§è¿½è¸ªçš„å›è°ƒï¼Œä»è€Œå½“è¿™ä¸ª View æ·»åŠ åˆ°çª—å£æ—¶ï¼Œä» Handler ä¸­ç§»é™¤è¯¥å›è°ƒï¼›åœ¨çª—å£ç§»é™¤æ—¶å†æ·»åŠ åˆ° Handler ä¸­ï¼Œä»è€Œè§¦å‘ view å¯¹è±¡çš„å¯è¾¾æ€§è¿½è¸ªã€‚

#### ServiceWatcher

ç”¨äºç›‘å¬ æœåŠ¡ å¯¹è±¡æ˜¯å¦æ³„æ¼çš„è§‚å¯Ÿè€…ï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š

![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.16hnkma97n9c.png)

ä¸Šè¿°çš„æµç¨‹ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå¤æ‚ï¼Œæºç éƒ¨åˆ†æˆ‘ä»¬åšäº†å¤§é‡åˆ å‡ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š

*   å½“ **ServiceWatcher** åœ¨ `install()` æ—¶ï¼Œä¼šé€šè¿‡åå°„çš„æ–¹å¼å–å‡º **ActivityThread** ä¸­çš„ `mH`(Handler)ï¼Œå¹¶ä½¿ç”¨è‡ªå®šä¹‰çš„ `CallBack` æ›¿æ¢ **Handler** ä¸­åŸæ¥çš„ `mCallBack` ï¼Œå¹¶ç¼“å­˜åŸæ¥çš„ `mCallBack` ï¼Œä»è€Œåšåˆ°ç›‘å¬ service çš„åœæ­¢ï¼Œå¹¶ä¸”å»¶ç»­åŸ `callBack` æµç¨‹çš„ç»§ç»­ã€‚å½“ **Handler** ä¸­æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯ _msg.what == STOP_SERVICE_ æ—¶ï¼Œåˆ™è¯æ˜å½“å‰ service å³å°†åœæ­¢ï¼Œåˆ™å°†è¯¥ service åŠ å…¥è¦è¿½è¸ªçš„æœåŠ¡é›†åˆä¸­ã€‚
*   æ¥ä¸‹æ¥ hook **ActivityManagerService** ï¼Œå¹¶ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼å»ä»£ç†è¯¥ **IActivityManager** å¯¹è±¡ï¼Œä»è€Œç›‘å¬è¯¥å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ã€‚å¦‚æœå½“å‰è°ƒç”¨çš„æ–¹æ³•æ˜¯ `serviceDoneExecuting()`ï¼Œåˆ™è¯æ˜ service å·²çœŸæ­£ç»“æŸã€‚å³ä»å½“å‰å¾…è¿½è¸ªçš„æœåŠ¡é›†åˆä¸­å–å‡ºè¯¥ service å¹¶å¯¹å…¶è¿›è¡Œå¯è¾¾æ€§è¿½è¸ªï¼Œå¹¶ä»è¯¥é›†åˆä¸­ç§»é™¤è¯¥ service å¯¹è±¡ã€‚

### å¦‚ä½•åˆ¤å®šå†…å­˜æ³„æ¼

æœ¬å°èŠ‚å°†è¦æ¥åˆ°æˆ‘ä»¬æœ¬ç¯‡çš„é‡å¤´æˆï¼Œå³å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦çœŸçš„å†…å­˜æ³„æ¼ ğŸ§ ã€‚

åœ¨ä¸Šè¿°åˆ†æä¸­ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œå¯¹äºå¯¹è±¡çš„å¯è¾¾æ€§è¿½è¸ªï¼Œå³æ˜¯å¦å†…å­˜æ³„æ¼ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼š

**reachabilityWatcher.expectWeaklyReachable(view,xxx)**

è€Œ `reachabilityWatcher` åªæœ‰ä¸€ä¸ªå…·ä½“çš„å®ç°ç±»ï¼Œå³ **ObjectWatcher**ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æ’å…¥ç‚¹ä»è¿™é‡Œå¼€å§‹ğŸ”º ->

æˆ‘ä»¬å»çœ‹çœ‹ç›¸åº”çš„ **expectWeaklyReachable** æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

> ObjectWatcher.expectWeaklyReachable()

```
@Synchronized override fun expectWeaklyReachable(
  watchedObject: Any,
  description: String
) {
  ...
  // å› ä¸ºæ‰€æœ‰è¿½è¸ªçš„å¯¹è±¡é»˜è®¤éƒ½è®¤ä¸ºæ˜¯å³å°†è¢«é”€æ¯ï¼Œå³å¼±å¯è¾¾å¯¹è±¡ã€‚
  // è¿™é‡Œè¿™é‡Œå†æ¬¡å¯¹ReferenceQueueå‡ºç°çš„å¼±å¼•ç”¨è¿›è¡Œç§»é™¤
  removeWeaklyReachableObjects()
  // ç”Ÿæˆä¸€ä¸ªéšæœºçš„UUID
  val key = UUID.randomUUID().toString()
  // è®°å½•å½“å‰çš„ç›‘æµ‹å¼€å§‹æ—¶é—´
  val watchUptimeMillis = clock.uptimeMillis()
  // ä½¿ç”¨ä¸€ä¸ªå¼±å¼•ç”¨æŒæœ‰å½“å‰è¦è¿½è¸ªçš„ å¼±å¯è¾¾å¯¹è±¡
  // å¹¶ä¸”è°ƒç”¨äº†åŸºç±»çš„ WeakReference<Any>(referent, referenceQueue)æ„é€ å™¨
  // è¿™æ ·çš„è¯ï¼Œå¼±å¼•ç”¨åœ¨è¢«å›æ”¶ä¹‹å‰ä¼šå‡ºç°åˆ° referenceQueue ä¸­
  val reference =
    KeyedWeakReference(watchedObject, key, description, watchUptimeMillis, queue)
  // å°†è¯¥å¼•ç”¨å¯¹è±¡å­˜å…¥è§‚å¯ŸMapä¸­
  watchedObjects[key] = reference
  
  // å»¶è¿Ÿæ£€æµ‹å½“å‰å¼±å¼•ç”¨å¯¹è±¡ï¼Œä»è€Œåˆ¤æ–­å¯¹è±¡æ˜¯å¦è¢«å›æ”¶ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¯æ˜å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼
  // é»˜è®¤å»¶è¿Ÿ5såæ‰§è¡Œï¼Œå…·ä½“å‚è§ä¸Šè¿° manualInstall()
  // this.retainedDelayMillis = TimeUnit.SECONDS.toMillis(5)
  checkRetainedExecutor.execute {
    moveToRetained(key)
  }
}

  @Synchronized private fun moveToRetained(key: String) {
    // å…ˆå°†å¼•ç”¨é˜Ÿåˆ—ä¸­çš„å¯¹è±¡ä»é˜Ÿåˆ—ä¸­åˆ é™¤
    removeWeaklyReachableObjects()
    // è·å–æŒ‡å®škeyå¯¹åº”çš„å¼±å¼•ç”¨å¯¹è±¡
    val retainedRef = watchedObjects[key]
    // å¦‚æœå½“å‰çš„å¼±å¼•ç”¨å¯¹è±¡ä¸ä¸ºnull,åˆ™è¯æ˜å¯èƒ½å‘ç”Ÿäº†å†…å­˜æ³„æ¼
    if (retainedRef != null) {
      // è®°å½•å†…å­˜æ³„æ¼æ—¶é—´ï¼Œå¹¶é€šçŸ¥æ‰€æœ‰å¯¹è±¡ï¼Œå½“å‰å·²å‘ç”Ÿå†…å­˜æ³„æ¼
      retainedRef.retainedUptimeMillis = clock.uptimeMillis()
      onObjectRetainedListeners.forEach { it.onObjectRetained() }
    }
  }

  private fun removeWeaklyReachableObjects() {
    // å°†å¼•ç”¨é˜Ÿåˆ—ä¸­çš„å¯¹è±¡ä»é˜Ÿåˆ—ä¸­åˆ é™¤
    var ref: KeyedWeakReference?
    do {
      // å¦‚æœä¸ä¸ºnullï¼Œåˆ™è¯æ˜è¯¥å¯¹è±¡å·²ç»è¢«å›æ”¶
      // 
      ref = queue.poll() as KeyedWeakReference?
      if (ref != null) {
        watchedObjects.remove(ref.key)
      }
    } while (ref != null)
  }
å¤åˆ¶ä»£ç 
```

ä¸Šè¿°æ–¹æ³•ä¸­ï¼Œå…ˆè°ƒç”¨ `removeWeaklyReachableObjects()` æ–¹æ³• **å¯¹å½“å‰çš„å¼•ç”¨é˜Ÿåˆ—è¿›è¡Œäº†æ¸…é™¤**ã€‚ç„¶åç”Ÿæˆäº† **KeyedWeakReference** å¼±å¼•ç”¨å¯¹è±¡ï¼Œå†…éƒ¨æŒæœ‰è€…å½“å‰è¦è¿½è¸ªçš„å¯¹è±¡ï¼Œå¹¶ä¸”è®°å½•äº†å½“å‰çš„æ—¶é—´ï¼Œkey ç­‰ä¿¡æ¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåœ¨åˆå§‹åŒ– **KeyedWeakReference** æ—¶ï¼Œæ„é€ å‡½æ•°ä¸­è¿˜ä¼ å…¥äº† _**queue**_ ï¼Œè€Œè¿™æ ·çš„ç›®çš„æ˜¯ä¸ºäº† **å†è¿›è¡Œä¸€éå¯¹è±¡æ˜¯å¦å›æ”¶çš„ check** ã€‚ç„¶åå°†åˆ›å»ºå¥½çš„å¼±å¼•ç”¨è§‚å¯Ÿå¯¹è±¡æ·»åŠ åˆ°æˆ‘ä»¬çš„è§‚å¯Ÿ Map ä¸­ï¼Œå¹¶ä½¿ç”¨ **Handler** `å»¶è¿Ÿ5s` åå†å»æ£€æµ‹è¯¥å¯¹è±¡æ˜¯å¦çœŸçš„è¢«å›æ”¶ã€‚

> **åˆå§‹åŒ– KeyedWeakReference ï¼Œä¸ºä»€ä¹ˆè¦ä¼ å…¥é˜Ÿåˆ— queue ï¼Ÿ**
> 
> å½“æˆ‘ä»¬å¼±å¼•ç”¨ä¸­æ‰€æŒæœ‰çš„å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œå³ç›¸å½“äºæˆ‘ä»¬å¼±å¼•ç”¨æœ¬èº«ä¹Ÿæ²¡æœ‰ç”¨äº†ï¼Œæ­¤æ—¶ï¼Œjava ä¼šå°†æˆ‘ä»¬å½“å‰çš„å¼±å¼•ç”¨å¯¹è±¡ï¼Œæ·»åŠ åˆ°æˆ‘ä»¬æ‰€ä¼ é€’çš„é˜Ÿåˆ— (queue) ä¸­å»ã€‚å³æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸäº›é€»è¾‘å»åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨æˆ‘ä»¬æŒ‡å®šçš„å¼±å¼•ç”¨å¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¯æ˜å¯¹è±¡å·²ç»è¢«å›æ”¶ï¼Œå¦åˆ™å³å­˜åœ¨æ³„æ¼çš„é£é™©ã€‚

å½“ 5s å»¶è¿Ÿç»“æŸåï¼Œè°ƒç”¨ `moveToRetained()` æ–¹æ³•å†æ¬¡å»æ£€æµ‹è¯¥å¯¹è±¡ã€‚æ£€æµ‹æ—¶ï¼Œä¾ç„¶å…ˆè°ƒç”¨ `removeWeaklyReachableObjects()` å°†å¯èƒ½å·²ç»è¢«å›æ”¶çš„å¯¹è±¡è¿›è¡Œæ¸…é™¤ï¼Œé¿å…è¯¯åˆ¤ã€‚æ­¤æ—¶å¦‚æœå½“å‰æˆ‘ä»¬è¦æ£€æµ‹çš„ key æ‰€å¯¹åº”å¼±å¼•ç”¨å¯¹è±¡ä¾ç„¶å­˜åœ¨ï¼Œåˆ™è¯æ˜è¯¥å¯¹è±¡æ²¡æœ‰è¢«æ­£å¸¸å›æ”¶ï¼Œå¯èƒ½å‘ç”Ÿäº†å†…å­˜æ³„æ¼ã€‚**æ­¤æ—¶è®°å½•å†…å­˜æ³„æ¼çš„å‘ç”Ÿçš„æ—¶é—´ï¼Œå¹¶é€šçŸ¥æ‰€æœ‰å¯¹è±¡**ã€‚

æ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å»çœ‹çœ‹ **onObjectRetained()** æ–¹æ³•å³å¯ã€‚

#### onObjectRetained()

> InternalLeakCanary.onObjectRetained()

ç”¨äºæ£€æµ‹å¯¹è±¡æ˜¯å¦çœŸçš„å­˜åœ¨æ³„éœ²ï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dbca632461fc421bb61e1ea4f966a748~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ä¸Šè¿°é€»è¾‘å¦‚ä¸‹ï¼Œå…ˆåˆ¤æ–­å½“å‰æ˜¯å¦æ­£åœ¨æ£€æŸ¥å¯¹è±¡æ˜¯å¦æ³„æ¼ä¸­ï¼Œå¦‚æœæ­£åœ¨æ£€æŸ¥ï¼Œåˆ™ç›´æ¥è·³è¿‡ï¼Œå¦åˆ™è·å¾—å½“å‰ç³»ç»Ÿæ—¶é—´ + éœ€è¦å»¶è¿Ÿçš„æ—¶é—´ (è¿™é‡Œæ˜¯`0s`)ï¼Œå¹¶åœ¨åå°çº¿ç¨‹å»¶è¿ŸæŒ‡å®šæ—¶é—´åï¼Œå†å»æ£€æµ‹æ˜¯å¦æ³„æ¼ã€‚

#### checkRetainedObjects()

å†æ¬¡å»æ£€æŸ¥å½“å‰ä»æœªå›æ”¶çš„å¯¹è±¡ï¼Œå¦‚æœè¿™æ¬¡ä¾ç„¶å­˜åœ¨ï¼Œåˆ™è¯æ˜çœŸçš„æ³„æ¼äº†ï¼Œè¿™é‡Œç›¸å½“äºæ˜¯æœ€ç»ˆå®¡åˆ¤ã€‚

![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.1fdgrsaox7gg.png)

ä¸Šè¿°é€»è¾‘å¦‚ä¸‹ï¼Œæˆ‘ä»¬åˆ†ä¸ºä¸‰æ­¥æ¥çœ‹ï¼š

1.  å†…éƒ¨ä¼šå…ˆè°ƒç”¨ `objectWatcher.retainedObjectCount` è·å¾—å½“å‰å·²ç»æ³„æ¼çš„å¯¹è±¡ä¸ªæ•°ï¼›
    
    > ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/300db6c9c8c040af8e6b429de297ca54~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)
    > 
    > å¦‚æœä½ è¿˜è®°å¾—æˆ‘ä»¬ä¸Šé¢ å»¶è¿Ÿ `5s` å†å»æ£€æµ‹å¯¹è±¡æ˜¯å¦æ³„æ¼çš„ `moveToRetained()` æ–¹æ³•ï¼Œå°±ä¼šè®°å¾—ï¼Œè¯¥æ–¹æ³•å†…éƒ¨å¯¹ `retainedUptimeMillis` å­—æ®µè¿›è¡Œäº†è®¾ç½®ã€‚
    
2.  å¦‚æœæ³„æ¼çš„æ•°é‡ > 0ï¼Œåˆ™ GC ä¸€æ¬¡åå†æ¬¡è·å–æ³„æ¼ä¸ªæ•°ï¼›
    
    > è¿™é‡Œçš„ `gcTrigger.runGc()` å®åˆ™æ˜¯è°ƒç”¨ `GcTrigger.Default.runGc()`ï¼š
    > 
    > ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09225df8e1ef491faf215e718fe6f0cb~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)
    > 
    > åœ¨ç³»ç»Ÿçš„æ³¨é‡Šä¸­ï¼Œä½¿ç”¨ `Runtime.getRuntime().gc()` å¯ä»¥æ¯” `System.gc()` æ›´å®¹æ˜“è§¦å‘;(å› ä¸º java çš„åƒåœ¾å›æ”¶æ›´å¤šåªæ˜¯é€šçŸ¥æ‰§è¡Œï¼Œè‡³äºæ˜¯å¦çœŸçš„æ‰§è¡Œï¼Œå®åˆ™æ˜¯ä¸ç¡®å®šçš„)ã€‚
    > 
    > éœ€è¦æ³¨æ„æ˜¯ï¼Œ**è¯¥æ–¹æ³•å†…éƒ¨åœ¨ GC åè¿˜å»¶è¿Ÿäº† 100ms** , ä»è€Œä»¥ä¾¿ä½¿å¾—è™šæ‹ŸæœºçœŸçš„ GC åï¼Œä»è€Œå°†å¼±å¼•ç”¨ç§»åŠ¨åˆ°æˆ‘ä»¬ä¼ é€’å¼•ç”¨é˜Ÿåˆ—ä¸­å»ã€‚(å› ä¸ºæˆ‘ä»¬åœ¨åˆå§‹åŒ– **KeyedWeakReference** æ—¶ï¼Œå†…éƒ¨ä¼ é€’äº†ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—), è¿™é‡Œä»ç„¶åœ¨ä¿åº• checkã€‚
    
3.  æ¥ç€å†æ¬¡è°ƒç”¨ `checkRetainedCount()` åˆ¤æ–­å½“å‰æ³„æ¼çš„å¯¹è±¡æ˜¯å¦åˆ°è¾¾é˜ˆå€¼ï¼Œå¦‚æœè¾¾åˆ°äº†ï¼Œåˆ™ç›´æ¥ **dump heap** , å¹¶å‘å‡ºä¸€ä¸ªå†…å­˜æ³„æ¼çš„é€šçŸ¥ï¼Œå¦åˆ™åˆ™åªæ‰“å°ä¸€ä¸‹æ³„æ¼çš„æ—¥å¿—ã€‚
    
    ![](https://cdn.staticaly.com/gh/Petterpx/ImageRespoisty@main/img/petterp-image.16u27eanrl1c.png)
    

æ€»ç»“
--

åœ¨æœ¬ç¯‡ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å¯¹äº **LeakCanary** çš„ä½¿ç”¨æ–¹å¼ä»¥åŠåº”ç”¨å±‚çš„å®ç°åŸç†åšäº†è¾ƒå®Œæ•´çš„åˆ†æï¼Œä»è€Œä»¥ä¸€ä¸ªç›´è§‚çš„è§†è§’ç†è§£å…¶åº”ç”¨å±‚çš„è®¾è®¡æ€æƒ³ã€‚æœ€åè®©æˆ‘ä»¬æˆ‘ä»¬å†æ¬¡å»å›é¡¾ä¸€ä¸‹ä¸Šè¿°æ•´ä¸ªæµç¨‹ï¼š

1.  **åˆå§‹åŒ–åšäº†ä»€ä¹ˆï¼Ÿ**
    
    å› ä¸º `LeakCanary` ä½¿ç”¨äº† **ContentProvider**ï¼Œæ‰€ä»¥åˆå§‹åŒ–çš„é€»è¾‘ä¸éœ€è¦å¼€å‘è€…æ‰‹åŠ¨ä»‹å…¥ï¼Œé»˜è®¤åœ¨åˆå§‹åŒ–çš„å†…éƒ¨ï¼Œå…¶ä¼šæ³¨å†Œ App å…¨å±€çš„ç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼Œå¹¶ä¸”åˆå§‹åŒ–äº†ç›¸åº”çš„ç›‘å¬æ’ä»¶ï¼Œæ¯”å¦‚ å¯¹äº Activity çš„ `ActivityWatcher`ï¼ŒFragment å’Œ ViewModel çš„ `FragmentAndViewModelWatcher` ç­‰ã€‚
    
2.  **å„ç»„ä»¶çš„å†…å­˜æ³„æ¼ç›‘å¬æ–¹æ¡ˆæ˜¯æ€æ ·è®¾è®¡çš„å‘¢ï¼Ÿ**
    
    *   _Activity(ActivityWatcher)_
        
        å†…éƒ¨æ³¨å†Œäº†ä¸€ä¸ª **Activity** çš„å…¨å±€ç”Ÿå‘½å‘¨æœŸç›‘å¬ï¼Œä»è€Œåœ¨ `onDestory()` æ—¶å»è¿½è¸ªå½“å‰ activity å¯¹è±¡æ˜¯å¦å†…å­˜æ³„æ¼ã€‚
        
    *   _Fragment(FragmentAndViewModelWatcher)_
        
        å…ˆæ³¨å†Œ _Act-Lifecycle_ ç›‘å¬ï¼Œç„¶ååœ¨ `onCreate()` æ—¶è¿›è¡Œ _Fragment-Lifecycle_ æ³¨å†Œç›‘å¬ï¼Œå¹¶åœ¨ `onFragmentViewDestroyed()` ä¸ `onFragmentDestroyed()` å¯¹ view å¯¹è±¡ ä¸ fragment å¯¹è±¡ è¿›è¡Œäº†å†…å­˜æ³„æ¼è¿½è¸ªã€‚
        
    *   _RootViewWatcher(RootViewWatcher)_
        
        ä½¿ç”¨ **curtains** åº“ç›‘å¬æ‰€æœ‰æ ¹ View çš„åˆ›å»ºä¸é”€æ¯ï¼Œå¹¶åˆå§‹åŒ–äº†ä¸€ä¸ª `runable` ç”¨äºç›‘å¬è§†å›¾æ˜¯å¦æ³„æ¼ã€‚åœ¨å½“å‰ view è¢«æ·»åŠ åˆ°çª—å£æ—¶ï¼Œåˆ™ä» handler ä¸­ç§»é™¤è¯¥ `runable` ï¼›å¦‚æœå½“å‰ view ä»çª—å£ç§»é™¤æ—¶ï¼Œåˆ™è§¦å‘è¯¥ runable çš„æ‰§è¡Œã€‚
        
    *   å…¶ä»–ç»„ä»¶å¯åœ¨å…·ä½“çš„æºç åˆ†ææœ«å°¾ï¼ŒæŸ¥çœ‹æ€»ç»“å³å¯ï¼Œ**è¿™é‡Œå°±ä¸å†å¤è¿°äº†ğŸ˜‰**
        
3.  **å¦‚ä½•åˆ¤å®šå†…å­˜æ³„æ¼å‘¢ï¼Ÿ**
    
    å¯¹äºè¦ç›‘å¬çš„å¯¹è±¡ï¼Œä½¿ç”¨ `KeyedWeakReference` ä¸å…¶è¿›è¡Œå…³è” (åˆå§‹åŒ–æ—¶ä¼ å…¥äº†ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ— queue)ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°ä¸“é—¨çš„ è§‚å¯Ÿ Map ä¸­ã€‚è¿™æ ·å½“è¯¥å¯¹è±¡è¢« Gc å›æ”¶æ—¶ï¼Œå°±ä¼šå‡ºç°åœ¨ ç›¸åº”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚ç„¶åï¼Œä½¿ç”¨ Handler å»¶è¿Ÿ `5s`åå†å»åˆ¤æ–­æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ã€‚
    
    åœ¨å…·ä½“çš„åˆ¤æ–­é€»è¾‘ä¸­ï¼Œä¼šå…ˆå°†å¼•ç”¨é˜Ÿåˆ—ä¸­å‡ºç°çš„å¯¹è±¡ä»è¦è§‚å¯Ÿçš„ Map ä¸­ç§»é™¤ï¼Œä»è€Œé¿å…è¯¯åˆ¤ã€‚ç„¶åå†åˆ¤æ–­å½“å‰è¦è§‚å¯Ÿçš„å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜æ²¡æœ‰å†…å­˜æ³„æ¼ï¼›å¦åˆ™æ„å‘³ç€å¯èƒ½å‡ºç°äº†å†…å­˜æ³„æ¼ï¼Œåˆ™è°ƒç”¨ `Runtme.getRunTime().gc()` è¿›è¡Œ GC é€šçŸ¥ï¼Œå¹¶ä¸”ç­‰å¾… `100ms` åå†æ¬¡æ‰§è¡Œåˆ¤æ–­ï¼Œè‹¥è¯¥è§‚å¯Ÿçš„å¯¹è±¡ä»ç„¶å­˜åœ¨äº è§‚å¯Ÿè€… Map ä¸­ï¼Œåˆ™è¯æ˜è¯¥å¯¹è±¡çœŸçš„å·²ç»æ³„æ¼ï¼Œæ­¤æ—¶å°±ä¼šæ ¹æ®å†…å­˜æ³„æ¼çš„ä¸ªæ•° **å¼¹å‡ºé€šçŸ¥** æˆ–è€…å¼€å§‹ **dump hprof** ã€‚
    
    è‡³æ­¤ï¼Œå…³äº **LeakCanary** çš„åº”ç”¨å±‚åˆ†æï¼Œåˆ°è¿™é‡Œå°±ç»“æŸäº†ã€‚
    
    æ›´æ·±å±‚çš„å¦‚ä½•ç”Ÿæˆ **hprof æ–‡ä»¶** ä»¥åŠå…¶è§£ææ–¹å¼ï¼Œè¿™å¹¶éæœ¬ç¯‡æ‰€è¦æ¢ç´¢çš„æ–¹å‘ï¼Œå½“ç„¶å¦‚æœä½ ä¹Ÿæ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œå¯ä»¥é€šè¿‡æŸ¥é˜…å…¶ä»–åŒå­¦çš„èµ„æ–™ä»è€Œå¾—åˆ°æ›´åŠ æ·±å…¥çš„ç†è§£ğŸ§ã€‚
    

å‚é˜…
--

*   [LeakCanary æ–‡æ¡£](https://link.juejin.cn?target=https%3A%2F%2Fsquare.github.io%2Fleakcanary%2F "https://square.github.io/leakcanary/")
*   [Yorkekâ€™s - LeakCanary2 æºç è§£æ](https://link.juejin.cn?target=https%3A%2F%2Fblog.yorek.xyz%2Fandroid%2F3rd-library%2Fleakcanary%2F "https://blog.yorek.xyz/android/3rd-library/leakcanary/")

æ›´å¤š
--

è¿™æ˜¯ è§£ç ç³»åˆ— - **LeakCanary** ç¯‡ï¼Œå¦‚æœä½ è§‰å¾—è¿™ä¸ªç³»åˆ—å†™çš„è¿˜ä¸é”™ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹å…¶ä»–ç¯‡ï¼š

> *   [ç”±æµ…å…¥æ·±ï¼Œè¯¦è§£ Lifecycle çš„é‚£äº›äº‹](https://juejin.cn/post/7168868230977552421 "https://juejin.cn/post/7168868230977552421")
> *   [ç”±æµ…å…¥æ·±ï¼Œè¯¦è§£ LiveData çš„é‚£äº›äº‹](https://juejin.cn/post/7173494700081414181 "https://juejin.cn/post/7173494700081414181")
> *   [ç”±æµ…å…¥æ·±ï¼Œè¯¦è§£ ViewModel çš„é‚£äº›äº‹](https://juejin.cn/post/7186680109384859706 "https://juejin.cn/post/7186680109384859706")

å…³äºæˆ‘
---

æˆ‘æ˜¯ _Petterp_ , ä¸€ä¸ª Android å·¥ç¨‹å¸ˆ ï¼Œå¦‚æœæœ¬æ–‡å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿ ç‚¹èµã€è¯„è®ºã€æ”¶è—ï¼Œä½ çš„æ”¯æŒæ˜¯æˆ‘æŒç»­åˆ›ä½œçš„æœ€å¤§é¼“åŠ±ï¼